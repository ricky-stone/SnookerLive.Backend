name: Deploy to server
run-name: Deploy ${{ inputs.service }} (${{ inputs.tag }})

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to deploy"
        required: true
        type: choice
        options:
          - snookerorg
          - snooker-api
          - match-api
          - player-api
          - ranking-api
          - watchon-api
          - event-api
          - frame-api
          - session-api
          - round-api
          - match-worker
          - events-worker
          - watchon-worker
          - round-worker
          - session-worker
          - live-match-sync
          - live-event-matches-sync
          - upcoming-event-matches-sync
          - finished-event-matches-sync
          - events-sync
          - round-sync
      tag:
        description: "Image tag to deploy (e.g. 1.2.1)"
        required: true

env:
  REGISTRY: image.tool.ovh
  SERVICE_DIR: /home/debian/projects/snookerlive

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Install sshpass
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass

      - name: Deploy via SSH (pull + up)
        env:
          HOST: ${{ secrets.SERVER_HOST }}
          USER: ${{ secrets.SERVER_USER }}
          PASS: ${{ secrets.SERVER_PASSWORD }}
          SERVICE: ${{ inputs.service }}
          TAG: ${{ inputs.tag }}
          HARBOR_USER: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASS: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no "$USER@$HOST" bash -lc "'
            set -euo pipefail

            cd \"${SERVICE_DIR}\"

            if [ ! -f compose.yml ]; then
              echo \"compose.yml not found in ${SERVICE_DIR}\" >&2
              exit 1
            fi

            echo \"${HARBOR_PASS}\" | docker login \"${REGISTRY}\" -u \"${HARBOR_USER}\" --password-stdin

            echo \"Deploying ${SERVICE} with tag ${TAG}\"

            TAG=\"${TAG}\" docker compose pull \"${SERVICE}\"
            TAG=\"${TAG}\" docker compose up -d \"${SERVICE}\"
            docker compose ps \"${SERVICE}\"
          '"
