name: Build and push to Harbor
run-name: Build ${{ inputs.service }} (${{ inputs.tag != '' && inputs.tag || github.sha }})

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Compose service to build"
        required: true
        type: choice
        options:
          - snookerorg
          - live-matches-sync
          - live-event-matches-sync
          - upcoming-event-matches-sync
          - finished-event-matches-sync
          - events-sync
          - player-sync
          - money-ranking-sync
          - money-seeding-sync
          - qtour-ranking-sync
          - womens-ranking-sync
          - round-sync
          - matches-worker
          - player-worker
          - ranking-worker
          - events-worker
          - watchon-worker
          - round-worker
          - match-api
          - round-api
          - player-api
          - watchon-api
          - event-api
          - notification-worker
          - session-worker
          - session-api
          - frame-worker
          - frame-api
          - ranking-api
          - snooker-api
          - match-seeder
      tag:
        description: "Image tag (leave blank to use short SHA)"
        required: false
        default: ""

env:
  REGISTRY: image.tool.ovh
  PROJECT: snookerlive

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Resolve service config
        id: cfg
        shell: bash
        run: |
          set -euo pipefail

          case "${{ inputs.service }}" in
            snookerorg) IMAGE="snookerorg"; DOCKERFILE="SnookerOrg/Dockerfile" ;;
            live-matches-sync) IMAGE="live-matches-sync"; DOCKERFILE="LiveMatchesSync/Dockerfile" ;;
            live-event-matches-sync) IMAGE="live-event-matches-sync"; DOCKERFILE="LiveEventMatchesSync/Dockerfile" ;;
            upcoming-event-matches-sync) IMAGE="upcoming-event-matches-sync"; DOCKERFILE="UpcomingEventMatchesSync/Dockerfile" ;;
            finished-event-matches-sync) IMAGE="finished-event-matches-sync"; DOCKERFILE="FinishedEventMatchesSync/Dockerfile" ;;
            events-sync) IMAGE="events-sync"; DOCKERFILE="EventsSync/Dockerfile" ;;
            player-sync) IMAGE="player-sync"; DOCKERFILE="PlayerSync/Dockerfile" ;;
            money-ranking-sync) IMAGE="money-ranking-sync"; DOCKERFILE="MoneyRankingSync/Dockerfile" ;;
            money-seeding-sync) IMAGE="money-seeding-sync"; DOCKERFILE="MoneySeedingSync/Dockerfile" ;;
            qtour-ranking-sync) IMAGE="qtour-ranking-sync"; DOCKERFILE="QTourRankingSync/Dockerfile" ;;
            womens-ranking-sync) IMAGE="womens-ranking-sync"; DOCKERFILE="WomensRankingSync/Dockerfile" ;;
            round-sync) IMAGE="round-sync"; DOCKERFILE="RoundSync/Dockerfile" ;;
            matches-worker) IMAGE="matches-worker"; DOCKERFILE="MatchesWorker/Dockerfile" ;;
            player-worker) IMAGE="player-worker"; DOCKERFILE="PlayerWorker/Dockerfile" ;;
            ranking-worker) IMAGE="ranking-worker"; DOCKERFILE="RankingWorker/Dockerfile" ;;
            events-worker) IMAGE="events-worker"; DOCKERFILE="EventsWorker/Dockerfile" ;;
            watchon-worker) IMAGE="watchon-worker"; DOCKERFILE="WatchOnWorker/Dockerfile" ;;
            round-worker) IMAGE="round-worker"; DOCKERFILE="RoundWorker/Dockerfile" ;;
            match-api) IMAGE="match-api"; DOCKERFILE="MatchApi/Dockerfile" ;;
            round-api) IMAGE="round-api"; DOCKERFILE="RoundApi/Dockerfile" ;;
            player-api) IMAGE="player-api"; DOCKERFILE="PlayerApi/Dockerfile" ;;
            watchon-api) IMAGE="watchon-api"; DOCKERFILE="WatchOnApi/Dockerfile" ;;
            event-api) IMAGE="event-api"; DOCKERFILE="EventApi/Dockerfile" ;;
            notification-worker) IMAGE="notification-worker"; DOCKERFILE="NotificationWorker/Dockerfile" ;;
            session-worker) IMAGE="session-worker"; DOCKERFILE="SessionWorker/Dockerfile" ;;
            session-api) IMAGE="session-api"; DOCKERFILE="SessionApi/Dockerfile" ;;
            frame-worker) IMAGE="frame-worker"; DOCKERFILE="FrameWorker/Dockerfile" ;;
            frame-api) IMAGE="frame-api"; DOCKERFILE="FrameApi/Dockerfile" ;;
            ranking-api) IMAGE="ranking-api"; DOCKERFILE="RankingApi/Dockerfile" ;;
            snooker-api) IMAGE="snooker-api"; DOCKERFILE="Api/Dockerfile" ;;
            match-seeder) IMAGE="match-seeder"; DOCKERFILE="MatchSeeder/Dockerfile" ;;
            event-seeder) IMAGE="event-seeder"; DOCKERFILE="EventSeeder/Dockerfile" ;;
            *) echo "Service not registered"; exit 1 ;;
          esac

          if [[ ! -f "$DOCKERFILE" ]]; then
            echo "Dockerfile not found: $DOCKERFILE"
            exit 1
          fi

          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "dockerfile=$DOCKERFILE" >> "$GITHUB_OUTPUT"

      - name: Compute tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"
          if [[ -n "${{ inputs.tag }}" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="$SHORT_SHA"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ steps.cfg.outputs.dockerfile }}
          platforms: linux/amd64
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT }}/${{ steps.cfg.outputs.image }}:${{ steps.tag.outputs.tag }}