name: Prune workflow runs

on:
  schedule:
    - cron: '5 * * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const cutoff = new Date(now.getTime() - 15 * 60 * 1000);

            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            for (const workflow of workflows.data.workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.id,
                per_page: 100,
              });

              for (const run of runs.data.workflow_runs) {
                const runDate = new Date(run.created_at);
                if (runDate < cutoff) {
                  console.log(`Deleting run ${run.id} from ${runDate}`);
                  await github.rest.actions.deleteWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                  });
                }
              }
            }
